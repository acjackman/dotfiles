#!/bin/bash
# permissions hash: {{ include "dot_claude/permissions.json" | sha256sum }}
# settings hash: {{ output "sh" "-c" (print "sha256sum " (joinPath .chezmoi.homeDir ".claude/settings.json") " 2>/dev/null || echo none") | trim | splitList " " | first }}

SETTINGS_FILE="$HOME/.claude/settings.json"
PERMISSIONS_FILE="{{ .chezmoi.sourceDir }}/dot_claude/permissions.json"

# Create settings file if it doesn't exist
if [ ! -f "$SETTINGS_FILE" ]; then
    echo '{}' > "$SETTINGS_FILE"
fi

# Use jq to merge permissions into settings and disable auto-update
if command -v jq &> /dev/null; then
    PERMISSIONS=$(cat "$PERMISSIONS_FILE")
    jq --argjson perms "$PERMISSIONS" '.permissions = $perms | .autoUpdaterStatus = "disabled"' "$SETTINGS_FILE" > "$SETTINGS_FILE.tmp" && \
        mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
else
    echo "Warning: jq not found. Cannot update Claude permissions automatically."
    exit 1
fi
