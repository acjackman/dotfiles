# Chezmoi Dotfiles - Development Guide

## IMPORTANT: Working with Chezmoi

**ALWAYS edit the chezmoi source files, not the deployed files.**

Chezmoi manages dotfiles by keeping source files in this repository and deploying them to their target locations (e.g., `~/.config/`, `~/`, etc.).

### Critical Workflow

1. **Edit source files** in the chezmoi directory (this repository)
   - Example: Edit `dot_config/zsh/zshenv.zsh`
   - NOT: `~/.config/zsh/zshenv.zsh` (this will be overwritten)

2. **Preview changes** with `chezmoi diff`
   - Always review changes before applying

3. **Apply changes** with `chezmoi apply`
   - This deploys your changes to the target locations

4. **Verify** the deployed file has your changes

5. **When removing or renaming managed files**, add the old target path to `.chezmoiremove` so other machines clean up the stale file on their next `chezmoi apply`. Use paths relative to the home directory (e.g., `.config/old-app/config.toml`).

### Why This Matters

If you edit deployed files directly (e.g., `~/.config/zsh/zshenv.zsh`), your changes will be lost the next time `chezmoi apply` runs. Always edit the source in the chezmoi directory to make changes persistent.

### File Name Mapping

- `dot_` prefix → `.` (e.g., `dot_zshrc` → `~/.zshrc`)
- `private_` prefix → file mode 0600
- `executable_` prefix → file mode 0755
- Path separators: `dot_config/zsh/` → `~/.config/zsh/`

### Finding Configuration Files

**When looking for configuration files, ALWAYS check the chezmoi source first:**

1. **Locate the file in the repository using chezmoi patterns**
   - Check `dot_config/` for `.config/` files
     - Example: `~/.config/nvim/init.lua` → `dot_config/nvim/init.lua`
     - Example: `~/.config/zsh/` → `dot_config/zsh/`
   - Check the repository root for home directory dotfiles
     - Example: `~/.zshrc` → `symlink_dot_zshrc`
     - Example: `~/.editorconfig` → `symlink_dot_editorconfig`
   - **Note**: Files may have a `.tmpl` extension added
     - Example: `~/.config/zsh/zshrc.zsh` → `dot_config/zsh/zshrc.zsh.tmpl`
     - Example: `.chezmoi.toml` → `.chezmoi.toml.tmpl`

2. **Before editing, check if the file is generated by a script**
   - Some config files are generated by `run_onchange_` or `run_once_` scripts
   - Look for scripts in the same directory or parent directory as the config file
   - Example: `dot_config/leader-key/run_onchange_after_generate_config.py.tmpl` generates the leader-key config
   - Example: `dot_config/claude/run_onchange_after_generate_settings.sh.tmpl` generates `~/.config/claude/settings.json` from `permissions.json`
   - If a config is generated, edit the script or its input data, NOT the generated file
   - Common patterns: `run_onchange_*generate*`, `run_onchange_*build*`, `run_onchange_*create*`

4. **Use Glob/Grep in the chezmoi directory for exploratory searches**
   - Search in this repository NOT `~/.config/` or `~/`
   - This ensures you find the source files, not deployed copies

**Do NOT directly search or edit files in `~/.config/` or `~/` unless you confirm they are not managed by chezmoi.**

### Special Files

Chezmoi recognizes several special files that control its behavior. These are processed in a specific order:

#### `.chezmoiignore`

Specifies files/directories to exclude from management. Patterns match against **target paths** (not source paths).

- Supports glob patterns via `doublestar.Match` (e.g., `*.txt`, `backups/**`)
- Lines starting with `#` are comments (mid-line `#` needs preceding whitespace)
- Prefix patterns with `!` to negate (exclusions take priority)
- **Always interpreted as a template** (even without `.tmpl` extension)
- Files in subdirectories apply only to that subdirectory

Example:
```
README.md
*.log
backups/**

# OS-specific ignores
{{- if ne .chezmoi.os "darwin" }}
.config/macos-only/
{{- end }}
```

#### `.chezmoiremove`

Specifies files to **delete** from the target during `chezmoi apply`. Use for cleaning up deprecated configs.

- **Always interpreted as a template** (even without `.tmpl` extension)
- Patterns prefixed with `!` or listed in `.chezmoiignore` are never removed
- Use `.chezmoiignore` to prevent files from being created; use `.chezmoiremove` to delete existing files

Example:
```
# Remove old config locations
.old-bashrc
.config/deprecated-app/
```

#### `.chezmoiexternal.$FORMAT`

Includes external files/archives from URLs as if they were in the source state. Supports TOML, YAML, or JSON.

Types:
- `file` — Download a single file
- `archive` — Extract archive contents
- `archive-file` — Extract specific file from archive
- `git-repo` — Clone/pull a git repository

Key fields: `type`, `url`, `refreshPeriod`, `exact`, `executable`, `stripComponents`

Example (TOML):
```toml
[".vim/autoload/plug.vim"]
    type = "file"
    url = "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
    refreshPeriod = "168h"
```

#### `.chezmoidata.$FORMAT`

Static data files (TOML, YAML, JSON) that are merged into the template data dictionary. Read in lexical order. **Cannot be templates** (loaded before template engine starts).

#### `.chezmoidata/` (Directory)

Same as `.chezmoidata.$FORMAT` but as a directory containing multiple data files. All files merge to the root of the data dictionary.

#### `.chezmoitemplates/`

Directory containing reusable templates. Templates here can be included in source files using `{{ template "name" . }}`.

#### `.chezmoiversion`

Contains a semantic version specifying the minimum chezmoi version required. Checked before operations proceed.

#### `.chezmoiroot`

If present, specifies a subdirectory (relative path) to use as the actual source state root. Read before all other files. All other special files must be moved into the new root.

## Commands

### Chezmoi Management

- Apply changes: `chezmoi apply`
- Preview changes: `chezmoi diff`
- Check status: `chezmoi status`
- Edit file: `chezmoi edit <file>`
- Update from remote: `chezmoi update`
- Re-run scripts: `chezmoi apply --force`

### Testing & Validation

- Test shell config: `zsh -n ~/.zshrc` (syntax check)
- Test Python scripts: `python3 -m py_compile <file>`
- Validate TOML: `chezmoi execute-template < <file>.tmpl`

## Git Workflows

### Bare Repositories with Worktrees

When working with bare git repositories, I prefer a specific directory structure where worktrees are siblings to the `.bare` directory.

**Preferred Structure:**
```
~/dev/project-name/
  .bare/              # The bare repository
  main/               # Worktree for main branch
  feature-branch/     # Worktree for feature branch
  pr-123/             # Worktree for PR branch
  bugfix-name/        # Worktree for bugfix branch
  ...
```

**Key points:**
- The bare repository lives in `.bare/`
- Each branch gets its own worktree directory as a sibling to `.bare/`
- Worktree names typically match branch names (with `/` replaced by `-`)
- This allows easy navigation and multiple branches checked out simultaneously
- I use `worktrunk` (`wt`) to manage these git worktrees and branches

### Worktrunk (`wt`) Usage

Worktrunk is a Git worktree management CLI designed for parallel AI agent workflows. It simplifies managing multiple worktrees by abstracting Git's native worktree commands.

**Common Commands:**
```bash
wt switch --create feature    # Create worktree and branch
wt switch feature             # Switch to existing worktree
wt list                       # Show all worktrees with status
wt remove                     # Remove worktree; delete branch if merged
wt merge                      # Merge current branch into target
```

**With Claude Code:**
```bash
wt switch -x claude -c feature-name -- 'Task description'
# Creates branch, worktree, and launches Claude in one command
```

**Resources:**
- Docs: https://worktrunk.dev
- GitHub: https://github.com/max-sixty/worktrunk

## Code Style

### Shell Scripts (Bash/Zsh)

- Use `#!/usr/bin/env zsh` or `#!/usr/bin/env bash` for portability
- Use `#!/bin/sh` for POSIX-compliant scripts
- No comments unless documenting complex logic
- Prefer `[[ ]]` over `[ ]` in bash/zsh

### Python

- Use type hints (from `typing` import)
- Prefer `pathlib.Path` over string paths
- Use `tomllib` (3.11+) or `tomli` for TOML parsing
- Follow existing patterns: see `dot_config/leader-key/run_onchange_after_generate_config.py.tmpl`

### Lua (Neovim)

- Follow LazyVim conventions
- Use `vim.opt` for options, `vim.g` for globals
- Keep plugin configs in `lua/exact_plugins/`

### Templates

- Use chezmoi template syntax: `{{ .variable }}`
- Conditional blocks: `{{ if condition }}...{{ end }}`
- Access data with `.chezmoi.os`, `.chezmoi.homeDir`, etc.

## Conventions

- Prefix files with `dot_` for dotfiles (e.g., `dot_zshrc` → `~/.zshrc`)
- Use `run_onchange_` for scripts that run when file changes
- Use `run_once_` for one-time setup scripts
- Use `executable_` prefix for executable files
- Use `symlink_` for symlinks
- Use `private_` for sensitive files (mode 0600)
- Store reusable data in `.chezmoidata/` or `data/`
