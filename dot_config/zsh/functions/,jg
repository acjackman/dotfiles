# -*- mode: zsh -*- vim: ft=zsh

# ,jg - Jump to Git
#
# Pushd to a modified directory in the current branch

# Get the repo root
local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [[ -z "$repo_root" ]]; then
    echo "Not in a git repository" >&2
    return 1
fi

# Get the main branch (usually master or main)
local main_branch=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null | sed 's/origin\///')

# Fallback to master if origin/HEAD is not set
if [[ -z "$main_branch" ]]; then
    # TODO: Fetch default branch from git
    main_branch="main"
fi

# Set up preview command
local preview_cmd
if command -v eza >/dev/null 2>&1; then
    preview_cmd="eza --long --group-directories-first --color=always {}"
else
    preview_cmd="ls -la {}"
fi

# Stream directories to fzf as they're discovered
# Pipes git diffs -> extracts dirnames -> filters existing -> dedupes -> fzf
local selected
selected=$(
    {
        echo "."  # Always include repo root first
        {
            git diff --name-only "${main_branch}...HEAD" 2>/dev/null
            git diff --name-only --cached 2>/dev/null
            git diff --name-only 2>/dev/null
        } | while IFS= read -r file; do
            dir=$(dirname "$file")
            if [[ -d "${repo_root}/${dir}" ]]; then
                echo "$dir"
            fi
        done
    } | awk '!seen[$0]++' | fzf --prompt="Jump to directory: " \
        --preview="$preview_cmd" \
        --preview-window=right:50%:wrap \
        --height=100% \
        --no-multi
)

# Exit if no directory was selected
if [[ -z "$selected" ]]; then
    echo "No directory selected" >&2
    return 0
fi

# Convert to absolute path
local target_dir
if [[ "$selected" = "." ]]; then
    target_dir="$repo_root"
else
    target_dir="${repo_root}/${selected}"
fi

# Pushd to target directory
[[ -d "$target_dir" ]] && pushd "$target_dir" > /dev/null
