# -*- mode: zsh -*- vim: ft=zsh

# ,jg - Jump to Git Modified Directory
#
# Pushd to a modified directory in the current branch
# Skips picker if only one directory is modified

# Get the repo root
local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [[ -z "$repo_root" ]]; then
    echo "Not in a git repository" >&2
    return 1
fi

# Get the main branch (usually master or main)
local main_branch=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null | sed 's/origin\///')

# Fallback to master if origin/HEAD is not set
if [[ -z "$main_branch" ]]; then
    # TODO: Fetch default branch from git
    main_branch="main"
fi

# Get all modified directories (only leaf directories, no parents)
local -a dirs
dirs=($(
    {
        git diff --name-only "${main_branch}...HEAD" 2>/dev/null
        git diff --name-only --cached 2>/dev/null
        git diff --name-only 2>/dev/null
    } | while IFS= read -r file; do
        dir=$(dirname "$file")
        if [[ -d "${repo_root}/${dir}" ]]; then
            echo "$dir"
        fi
    done | awk '!seen[$0]++' | awk '
        # Store all directories
        { dirs[NR] = $0 }
        END {
            # For each directory
            for (i = 1; i <= NR; i++) {
                is_parent = 0
                # Check if any other directory is a subdirectory of it
                for (j = 1; j <= NR; j++) {
                    if (i != j && index(dirs[j], dirs[i] "/") == 1) {
                        is_parent = 1
                        break
                    }
                }
                # Print if it is not a parent of another directory
                if (!is_parent) {
                    print dirs[i]
                }
            }
        }
    '
))

# Exit if no modified directories found
if [[ ${#dirs[@]} -eq 0 ]]; then
    echo "No modified directories found" >&2
    return 0
fi

# If only one directory, go directly there
local selected
if [[ ${#dirs[@]} -eq 1 ]]; then
    selected="${dirs[1]}"
else
    # Set up preview command
    local preview_cmd
    if command -v eza >/dev/null 2>&1; then
        preview_cmd="eza --long --group-directories-first --color=always {}"
    else
        preview_cmd="ls -la {}"
    fi

    # Multiple directories - use fzf to select
    selected=$(printf '%s\n' "${dirs[@]}" | fzf --prompt="Jump to directory: " \
        --preview="$preview_cmd" \
        --preview-window=right:50%:wrap \
        --height=100% \
        --no-multi)
fi

# Exit if no directory was selected (user cancelled fzf)
if [[ -z "$selected" ]]; then
    echo "No directory selected" >&2
    return 0
fi

# Pushd to target directory
local target_dir="${repo_root}/${selected}"
[[ -d "$target_dir" ]] && pushd "$target_dir" > /dev/null
