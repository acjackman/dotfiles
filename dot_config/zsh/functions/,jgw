# -*- mode: zsh -*- vim: ft=zsh

# ,jgw - Jump to Git Worktree
#
# Pushd to the current relative directory in a different git worktree

# Get the current worktree root (might be a linked worktree)
local current_wt_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [[ -z "$current_wt_root" ]]; then
    echo "Not in a git repository" >&2
    return 1
fi

# Get current relative directory from current worktree root
local current_dir=$(git rev-parse --show-prefix 2>/dev/null)

# Get all worktrees
local worktrees=$(git worktree list 2>/dev/null)
if [[ -z "$worktrees" ]]; then
    echo "No git worktrees found" >&2
    return 1
fi

# Get the main repo root (first entry in worktree list)
local main_repo_root=$(echo "$worktrees" | head -1 | awk '{print $1}')

# Extract worktree paths and convert to relative (excluding current one)
local other_worktrees=""
while IFS= read -r line; do
    local wt_path=$(echo "$line" | awk '{print $1}')
    # Skip the current worktree (exact match)
    if [[ "$wt_path" == "$current_wt_root" ]]; then
        continue
    fi

    # Convert to relative display path using helper
    local rel_path=$(_jgw_relativize_path "$wt_path" "$main_repo_root")
    other_worktrees+="$rel_path"$'\n'
done <<< "$worktrees"
other_worktrees="${other_worktrees%$'\n'}"  # Remove trailing newline

if [[ -z "$other_worktrees" ]]; then
    echo "No other worktrees found" >&2
    return 1
fi

# Set up preview command for worktree picker
# Need to handle relative paths in preview by prepending main repo root
local preview_cmd
if command -v eza >/dev/null 2>&1; then
    preview_cmd="[[ {} == /* ]] && wt_path={} || wt_path='$main_repo_root'/{}; eza -la \"\$wt_path/$current_dir\" 2>/dev/null | head -30"
else
    preview_cmd="[[ {} == /* ]] && wt_path={} || wt_path='$main_repo_root'/{}; ls -la \"\$wt_path/$current_dir\" 2>/dev/null | head -30"
fi

# Use central fzf picker to select worktree
local selected_worktree=$(,j-fzf-picker "Select worktree: " "$other_worktrees" "$preview_cmd")

# Exit if no worktree was selected
if [[ -z "$selected_worktree" ]]; then
    echo "No worktree selected" >&2
    return 0
fi

# Convert selected path back to absolute using helper
local worktree_path=$(_jgw_absolutize_path "$selected_worktree" "$main_repo_root")

# Construct target path
local target_dir
if [[ -z "$current_dir" ]]; then
    # We're at repo root, go to worktree root
    target_dir="$worktree_path"
else
    # Go to same relative directory in selected worktree
    target_dir="${worktree_path}/${current_dir}"
fi

# Pushd to target directory
[[ -d "$target_dir" ]] && pushd "$target_dir" > /dev/null