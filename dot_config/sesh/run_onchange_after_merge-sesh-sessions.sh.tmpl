#!/bin/sh
# Concatenate all TOML files from subdirectories of ~/.config/sesh/ into sesh.toml

SESH_DIR="$HOME/.config/sesh"
CONFIG="$SESH_DIR/sesh.toml"

# Files: {{- $home := .chezmoi.homeDir -}} {{- range (glob (printf "%s/.config/sesh/**/*.toml" $home)) }}
# * {{ . }}: {{ include . | sha256sum -}}{{- end }}

# Warn if old sessions.d directory still has files
if [ -d "$SESH_DIR/sessions.d" ] && [ -n "$(ls -A "$SESH_DIR/sessions.d" 2>/dev/null)" ]; then
  echo "WARNING: files found in deprecated sessions.d/ â€” move them to a new subdirectory (e.g., acjackman/)"
fi

# Find .toml files in subdirectories (mindepth 2 skips root-level sesh.toml and backups)
# Sort by basename so numeric prefixes control order regardless of directory
TMPFILE=$(mktemp)
trap 'rm -f "$TMPFILE"' EXIT
find "$SESH_DIR" -mindepth 2 -name "*.toml" -type f \
  | awk -F/ '{print $NF "\t" $0}' \
  | sort \
  | cut -f2- > "$TMPFILE"

if [ ! -s "$TMPFILE" ]; then
  echo "No .toml files found in subdirectories of $SESH_DIR"
  exit 1
fi

# Concatenate all .toml files in sorted order with newlines between them
NEW_CONTENT=""
while IFS= read -r f; do
  [ -n "$NEW_CONTENT" ] && NEW_CONTENT="$NEW_CONTENT

"
  NEW_CONTENT="$NEW_CONTENT$(cat "$f")"
done < "$TMPFILE"

# Validate TOML before writing
if ! echo "$NEW_CONTENT" | python3 -c "import sys, tomllib; tomllib.loads(sys.stdin.read())" 2>&1; then
  echo "ERROR: Invalid TOML - config not updated"
  exit 1
fi

# Check if content changed
if [ -f "$CONFIG" ]; then
  OLD_CONTENT=$(cat "$CONFIG")
  if [ "$NEW_CONTENT" = "$OLD_CONTENT" ]; then
    echo "No changes"
    exit 0
  fi
  # Backup before overwriting
  BACKUP="$SESH_DIR/sesh.toml.$(date +%Y%m%d-%H%M%S).bak"
  cp "$CONFIG" "$BACKUP"
  echo "  Backed up to $BACKUP"
fi

# Write new config
echo "$NEW_CONTENT" >"$CONFIG"
echo "Merged $(wc -l < "$TMPFILE" | tr -d ' ') files into sesh.toml"
