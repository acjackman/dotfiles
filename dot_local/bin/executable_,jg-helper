#!/usr/bin/env bash

# Get the repo root
repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$repo_root" ]; then
    echo "Not in a git repository"
    exit 1
fi

# Get the main branch (usually master or main)
main_branch=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null | sed 's/origin\///')

# Fallback to master if origin/HEAD is not set
if [ -z "$main_branch" ]; then
    main_branch="master"
fi

# Get all files modified in this branch compared to the main branch
modified_files=$(git diff --name-only "${main_branch}...HEAD")

# Get unique directories from modified files
if [ -n "$modified_files" ]; then
    modified_dirs=$(echo "$modified_files" | xargs -I{} dirname {} | sort -u)
else
    modified_dirs=""
fi

# Filter directories to only include those that still exist
if [ -n "$modified_dirs" ]; then
    existing_dirs=""
    while IFS= read -r dir; do
        if [ -d "${repo_root}/${dir}" ]; then
            existing_dirs="${existing_dirs}${dir}"$'\n'
        fi
    done <<< "$modified_dirs"
    modified_dirs=$(echo "$existing_dirs" | grep -v '^$')
fi

# Always include repo root (shown as "." for current repo root)
all_dirs=$(echo -e ".\n$modified_dirs" | grep -v '^$' | sort -u)

# Count directories
dir_count=$(echo "$all_dirs" | wc -l | tr -d ' ')

# Bypass fzf if only one directory
if [ "$dir_count" -eq 1 ]; then
    selected="$all_dirs"
else
    selected=$(echo "$all_dirs" | fzf --prompt="Jump to directory: " \
        --preview="ls -la ${repo_root}/{} 2>/dev/null | head -30" \
        --preview-window=right:50%:wrap \
        --height=100%)
fi

# Exit if no directory was selected
if [ -z "$selected" ]; then
    echo "No directory selected"
    exit 0
fi

# Convert to absolute path
if [ "$selected" = "." ]; then
    target_dir="$repo_root"
else
    target_dir="${repo_root}/${selected}"
fi

# Output the path
echo "$target_dir"
